
<!DOCTYPE HTML><html lang="ko">
    <head>
        <title>PS1xxx Emulator</title>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
        <style type="text/css">
            body { background-color: lightblue; }

            tr td{ text-align: center; }

            input[type=checkbox] {
            	display: none;          // default check display off
            }

            input[type=checkbox] + .D4 {
                display: inline-block;
                position: relative;
                padding: 8px;
                background-color: gray;
                border: 1px dotted #1E441E;
                border-radius: 4px;
                font-weight: bold;
            }
            input[type=checkbox]:checked + .D4:after {
                position: absolute;
                left: 10px;
                top: 2px;
                color: #fff; 
                content: '\2714'; 
            }


            input[type=checkbox] + .D0 {
                display: inline-block;
                position: relative;
                padding: 8px;
                background-color: #A7D8A7;
                border: 1px dotted #1E441E;
                border-radius: 4px;
                font-weight: bold;
            }

            input[type=checkbox]:checked + .D0 {
                background-color: #5CB85C;
            }

            input[type=checkbox]:disabled + .D0 {
                background-color: #F5F5F5;
            }

            input[type=checkbox]:checked + .D0:after {
                position: absolute;
                left: 10px;
                top: 2px;
                color: #fff; 
                content: '\2714'; 
            }

            input[type=checkbox]:checked + .D2:after {
                font-size: 18px;
            }

            input[type=checkbox] + .D3 {
                font-size: 10px;
            }

            input[type=checkbox]:checked + .D3:after {
                left: 4px;
                top: 0px;
                font-size: 10px;
            }

            .tooltip {
                position: relative;
                display: inline-block;
			}
            .tooltip .tooltiptext {
                visibility: hidden;
                width: 40px;
                background-color: #555;
                color: #fff;
                text-align: center;
                border-radius: 3px;
                padding: 1px 0;

                /* Position the tooltip */
                position: absolute;
                z-index: 1;

                bottom: 100%;
                left: 50%;
                margin-left: -20px;
                transition: opacity 2s;
			}
			.tooltip:hover .tooltiptext {
                visibility: visible;
            }
            .tooltip .tooltiptext::after {
            	content: "";
                position: absolute;
                top: 100%;
                left: 50%;
                margin-left: -3px;
                border-style: solid;
                border-color: #555 transparent transparent transparent;
            }


            .select3 {
                border-radius: 5px;
            }
        </style>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
        <script type="text/javascript" src="jquery.cookie.js"></script>
    </head>

    <body>
        <center>
        <form>
        <h3>Device Select : 
        <select id="deviceSelect" name="DEVICE" class="select3" style='background-color:#7FFF00'>
            <option class="Device" value="2" name="PS1120" style='background-color:#A9A9A9' selected>PS1120</option>
            <option class="Device" value="1" name="PS1060" style='background-color:#7FFF00'>PS1060</option>
            <option class="Device" value="0" name="PS1030" style='background-color:#8B008B'>PS1030</option>
        </select>
        Group Type Select : 
        <select id="groupSelect" name="GROUP" class="select3" style='background-color:#7FFF00'>
            <option class="Group" value="4" style='background-color:#A9A9A9' disabled>4-Group</option>
            <option class="Group" value="6" style='background-color:#7FFF00' disabled>6-Group</option>
            <option class="Group" value="8" style='background-color:#8B008B' disabled>8-Group</option>
            <option class="Group" value="10" style='background-color:#8B008B' disabled selected>10-Group</option>
            <option class="Group" value="12" style='background-color:#8B008B' disabled>12-Group</option>
            <option class="Group" value="16" style='background-color:#8B008B' disabled>16-Group</option>
        </select>
        </h3>
        <h4>Operation : 
        <select id="id-cmd" name="COMMAND" class="select3" style='background-color:#7FFF00'>
            <option class="switchOff" value="0" style='background-color:#A9A9A9'>SWITCH OFF</option>
            <option class="switchOn" value="1" style='background-color:#7FFF00' selected>SWITCH ON</option>
            <option class="holdOff" value="2" style='background-color:#8B008B'>HOLD OFF</option>
            <option class="holdOn" value="3" style='background-color:#9932CC'>HOLD ON</option>
            <option class="releaseOff" value="4" style='background-color:#EFAE00'>RELEASE OFF</option>
            <option class="releaseOn" value="5" style='background-color:#F0E68C'>RELEASE ON</option>
            <option class="forceOff" value="6" style='background-color:#98FB98'>FORCE OFF</option>
            <option class="forceOn" value="7" style='background-color:#90EE90'>FORCE ON</option>
        </select>
        <input type="button" id="CommandGen" value="Command Generate">
        </h4>
        </form>

        <div id='cascade'>
        </div>
        <div id='container'>
        </div>

        <br>
        <label for="frame"><b>Frame : </b></label>
        <select id="frame" name="frameName" style="width:300px"></select>
        <input type="button" id="Analysis" value="Analysis">
        <input type="button" id="saveAs" value="Save">
        <br>
        <br>
        <textarea id="console" cols="100" rows="10" style="display:block; resize:none"></textarea>
        </center>




        <script language="javascript">
            var cmdList = [];             // sessionStorage or Cookie
            var cmdFrame = new Object();             // sessionStorage or Cookie
            var CurrentSwitch = new Array(120);
            var SubWindow;
            $(document).ready(function() {
                var container = $("#cascade");

//                container.append($('<br>'));
                var table = $('<table></table>').css({ border: '1px solid #92ACBB' });
                var row = $('<tr></tr>');
                for(var i=0; i<8; i++) {
                    row.append(
                        $('<th></th>').append(
                            $('<input>').prop({
                                type: 'checkbox',
                                id: 'Device'+i.toString(),//'PS1120'+i.toString(),
                                name: 'Device[]',
                                value: i.toString(),
                                checked: ((i==0)?true:false)
                            })
                        ).append(
                            $('<label></label>').prop({
                                class:'D0 D3 DeviceClass',
                                for:'Device'+i.toString()//'PS1120'+i.toString()
                            }).html('PS1120['+i.toString()+']')
                        )
                    )
                }
                table.append(row)
                container.append(table)
                container.append($('<br>'));

                var container = $("#container");
                table = $('<table></table>').css({ border: '1px solid #92ACBB' });
                for(var r=0; r<11; r++) {
                    row = $('<tr></tr>');
                    for(var c=0; c<13; c++) {
                        if( r == 0 ) {
                            var cell = $('<th></tr>');
                            if( c == 0 ) {
                                cell.append(
                                    $('<div></div>').prop({class: 'tooltip'}).append(
                                        $('<input>').prop({type: 'checkbox', id: 'all_switch_toggle'})
                                    ).append(
                                        $('<label></label>').prop({for: 'all_switch_toggle', class: 'D0 D3'})
                                    ).append(
                                        $('<span></span>').prop({class: 'tooltiptext'}).html('All Toggle')
                                    )
                                )
                            } else {
                                cell.append(
                                    $('<input>').css({display:'none'})
                                        .prop({type: 'checkbox', id: 'column'+(c-1).toString(), name:'column_select', value:(c-1).toString()})
                                ).append(
                                    $('<label></label>').prop({for: 'column'+(c-1).toString()}).html((c-1).toString())
                                )
                            }
                        } else {
                            if( c == 0 ) {
                                var cell = $('<th></th>').append(
                                    $('<input>').css({display:'none'})
                                        .prop({type: 'checkbox', id: 'row'+(r-1).toString(), name:'row_select', value:(r-1).toString()})
                                ).append(
                                    $('<label></label>').prop({for: 'row'+(r-1).toString()}).html((r-1).toString())
                                )
                            } else {
                                var num = ((11 - (c-1)) * 10) + (9 - (r-1));
                                var cell = $('<td></td>').append(
                                    $('<div></div>').prop({class: 'tooltip'}).append(
                                        $('<input>').prop({type: 'checkbox', id: 'switch'+num.toString(), name:'switch[]', value:num.toString()})
                                    ).append(
                                        $('<label></label>').css({width:'22px', height:'16px', fontSize:'8px', color:'#00F'})
                                            .prop({for: 'switch'+num.toString(), id: 'dut'+num.toString(), class: 'D0 D2 DutClass'}).html('OFF')
                                    ).append(
                                        $('<span></span>').prop({class: 'tooltiptext'}).html(num.toString())
                                    )
                                )
                            }

                            if( r == 10 ) {
                                cell.css({backgroundColor: '#00BFFF'});
                            } else if( r == 9 ) {
                                cell.css({backgroundColor: '#1E90FF'});
                            } else if( (r == 8) || (r == 7) ) {
                                cell.css({backgroundColor: '#40E0D0'});
                            } else if( (r == 6) || (r == 5) ) {
                                cell.css({backgroundColor: '#4169E1'});
                            } else if( (r == 4) || (r == 3) || (r == 2) || (r == 1) ) {
                                cell.css({backgroundColor: '#00FFFF'});
                            }
                        }
                        row.append(cell)
                    }
                    table.append(row)
                }
                container.append(table)

                CurrentSwitch.fill(0x0);
            });


            const SwitchText = ["OFF", "ON"];
            const SwitchColor = ["blue", "gray"];
            const color = ['#A9A9A9', '#7FFF00', '#8B008B', '#9932CC', '#EFAE00', '#F0E68C', '#98FB98', '#90EE90'];
            const maskbits = [ 0x0, 0x1, 0x3, 0x7, 0xF, 0x1F, 0x3F, 0x7F, 0xFF, 0x1FF, 0x3FF, 0x7FF, 0xFFF, 0x1FFF, 0x3FFF, 0x7FFF, 0xFFFF ];
            const CommandType = ["Single", "Single Switch", "Row Select", "Row & Switch Select", "Column Select", "Column & Switch Select", "Special", "All Switch Select"];
            const OperateType = ["Switch OFF", "Switch ON", "Hold OFF", "Hold ON", "Release OFF", "Release ON", "Force ON", "Force OFF"];
            var fullSwitch = 120;
            var totalSwitch = 120;        // total switch 개수.
            var deviceType = 2;         // device type : PS1120(2), PS1060(1), PS1030(0)
            var nRow = 10;               // row 개수(group 과 같다.)
            var nColumn = 12;            // column 개수.
            function create_group_map() {
                deviceType = parseInt($('#deviceSelect').val());
                totalSwitch = (2 ** deviceType) * 30;
                nRow = parseInt($('#groupSelect').val());
                nColumn = parseInt( Math.ceil(totalSwitch / nRow) );
                fullSwitch = nRow * nColumn;
//                dbgout(`Total switch : ${totalSwitch}, switch map : ${nRow} x ${nColumn}\n`);

                var container = $("#container");
                var table = $('<table></table>').css({ border: '1px solid #92ACBB' });
                for(var r=0; r<(nRow+1); r++) {
                    var row = $('<tr></tr>');
                    for(var c=0; c<(nColumn+1); c++) {
                        if( r == 0 ) {
                            var cell = $('<th></tr>');
                            if( c == 0 ) {
                                cell.append(
                                    $('<div></div>').prop({class: 'tooltip'}).append(
                                        $('<input>').prop({type: 'checkbox', id: 'all_switch_toggle'})
                                    ).append(
                                        $('<label></label>').prop({for: 'all_switch_toggle', class: 'D0 D3'})
                                    ).append(
                                        $('<span></span>').prop({class: 'tooltiptext'}).html('All Toggle')
                                    )
                                )
                            } else {
                                cell.append(
                                    $('<input>').css({display:'none'})
                                        .prop({type: 'checkbox', id: 'column'+(c-1).toString(), name:'column_select', value:(c-1).toString()})
                                ).append(
                                    $('<label></label>').prop({for: 'column'+(c-1).toString()}).html((c-1).toString())
                                )
                            }
                        } else {
                            if( c == 0 ) {
                                var cell = $('<th></th>').append(
                                    $('<input>').css({display:'none'})
                                        .prop({type: 'checkbox', id: 'row'+(r-1).toString(), name:'row_select', value:(r-1).toString()})
                                ).append(
                                    $('<label></label>').prop({for: 'row'+(r-1).toString()}).html((r-1).toString())
                                )
                            } else {
                                var num = (((nColumn-1) - (c-1)) * nRow) + ((nRow-1) - (r-1));
                                if( num < totalSwitch ) {
//                                var num = ((11 - (c-1)) * 10) + (9 - (r-1));
                                    var cell = $('<td></td>').append(
                                        $('<div></div>').prop({class: 'tooltip'}).append(
                                            $('<input>').prop({type: 'checkbox', id: 'switch'+num.toString(), name:'switch[]', value:num.toString()})
                                        ).append(
                                            $('<label></label>').css({width:'22px', height:'16px', fontSize:'8px', color:'#00F'})
                                                .prop({for: 'switch'+num.toString(), id: 'dut'+num.toString(), class: 'D0 D2 DutClass'}).html('OFF')
                                        ).append(
                                            $('<span></span>').prop({class: 'tooltiptext'}).html(num.toString())
                                        )
                                    )
                                } else {
//                                    dbgout(`${num} switch : ${r}, ${c}\n`);
                                    var cell = $('<td></td>').append(
                                        $('<div></div>').prop({class: 'tooltip'}).append(
                                            $('<input>').prop({type: 'checkbox', id: 'switch'+num.toString(), name:'switch[]', value:num.toString()})
                                        ).append(
                                            $('<label></label>').css({width:'22px', height:'16px', fontSize:'8px', color:'#00F'})
                                                .prop({for: 'switch'+num.toString(), id: 'dut'+num.toString(), class: 'D2 D4 DutClass'}).html('NC')
                                        ).append(
                                            $('<span></span>').prop({class: 'tooltiptext'}).html(num.toString())
                                        )
                                    )
                                }
                            }

                            if( deviceType == 2 ) {     // PS1120 : hardware branch color(1:1:2:2:4)
                                if( r == 10 ) {
                                    cell.css({backgroundColor: '#00BFFF'});
                                } else if( r == 9 ) {
                                    cell.css({backgroundColor: '#1E90FF'});
                                } else if( (r == 8) || (r == 7) ) {
                                    cell.css({backgroundColor: '#40E0D0'});
                                } else if( (r == 6) || (r == 5) ) {
                                    cell.css({backgroundColor: '#4169E1'});
                                } else if( (r == 4) || (r == 3) || (r == 2) || (r == 1) ) {
                                    cell.css({backgroundColor: '#00FFFF'});
                                }
                            }
                        }
                        row.append(cell)
                    }
                    table.append(row)
                }
                container.append(table)
            }


            var SwitchArray = new Array(4);
            for(var i=0; i<4; i++) SwitchArray[i] = new Array(16);


            function toByteHexString(byteArray) {
                var s = '';
                byteArray.forEach(function(byte) {
                    s += '0x' + ('0' + (byte & 0xFF).toString(16)).slice(-2) + ' ';
                });
                return s;
            }

            function toShortHexString(Array) {
                var s = '';
                Array.forEach(function(byte) {
                    s += '0x' + ('0' + (byte & 0xFFFF).toString(16)).slice(-4) + ' ';
                });
                return s;
            }

            function SetBitCount(n) {
                var cnt = 0;
                do {
                    cnt += n & 0x1;
                    n >>= 1;
                } while(n);

                return cnt;
            }


            function command_result(opcode, SwitchNumber) {
                SwitchNumber.forEach(function(sw, index) {
                    if( sw >= totalSwitch ) return;
                    if( (opcode == 0) || (opcode == 1) || (opcode == 2) || (opcode == 3) ) {
                        if( (CurrentSwitch[sw] & (1<<1)) == 0 ) {   // Hold된 Switch가 아닌 경우.
                            CurrentSwitch[sw] = opcode;
                            $('#dut'+sw.toString()).text(SwitchText[opcode & 0x1]).css("color", SwitchColor[opcode>>1]);
                        }
                    } else if( (opcode == 4) || (opcode == 5) ) {
                        if( (CurrentSwitch[sw] & (1<<1)) != 0 ) {   // Hold된 Switch인 경우.
                            CurrentSwitch[sw] = opcode & 0x1;
                            $('#dut'+sw.toString()).text(SwitchText[opcode & 0x1]).css("color", 'blue');
                        }
                    } else if( (opcode == 6) || (opcode == 7) ) {
                        CurrentSwitch[sw] = opcode & 0x1;
                        $('#dut'+sw.toString()).text(SwitchText[opcode & 0x1]).css("color", 'blue');
                    }
                });
            }

            function send_command(cs, cmd, select) {
//                dbgout(`chip select = ${cs.toString(16)}, command = ${cmd}, select = ${select}\n`);
                var Bytes = [];

                Bytes.push(0xAA);
                if( cs != 0 ) {
                    Bytes.push(cmd | 0x40);
                    Bytes.push(cs);
                } else {
                    Bytes.push(cmd);
                }
                if( select != null ) select.forEach(element => Bytes.push(element));
                Bytes.push(0x0);
                Bytes.push(0x0);

//                dbgout(`Command = ${Bytes}\n`);
                cmdFrame.cmdlist.push(Bytes);

                var str = '';//`Command(${Bytes.length}) : `
                Bytes.forEach(function(val) {
                    str += '0x' + ('0' + (val & 0xFF).toString(16)).toUpperCase().slice(-2) + ' ';
                });
                str += '\n';

                /* option editable.
                $('#frame').prepend($(`<option value="${str}" selected>`+str+"</option>"));
                */
                $('#frame').prepend($(`<option selected>`+str+"</option>"));
//                dbgout(`\nCommand(${Bytes.length}) : `+str);
            }

            var CmdEntry = function(device, group, cs, opcode, select) {
                this.in = {};
                this.in.device = device;
                this.in.group = group;
                this.in.cs = cs;
                this.in.opcode = opcode;
                this.in.select = select;
                this.cmdlist = [];
            }

            function generate_command(cs, opcode, SwitchNumber, column, row) {
                var select = [];
                var nSelect = SwitchNumber.length;
                var cmd = opcode & 0x07;

                var deviceName = $('#deviceSelect option:selected').text();
                var groupNumber = $('#groupSelect option:selected').val();
                cmdFrame = new CmdEntry(deviceName, groupNumber, cs, opcode, SwitchNumber);

//                dbgout(`chip select = 0x${cs.toString(16)}, opcode = ${opcode}, switch count = ${nSelect}, column = 0x${column.toString(16)}, row = 0x${row.toString(16)}\n`);

                // Cookie 생성.

//                if( nSelect == 120 ) {          // all switch select -> single command.
                if( nSelect == totalSwitch ) {          // all switch select -> single command.
                    cmd |= 0x00;
                } else if( nSelect == 1 ) {     // single switch select -> single switch command.
                    cmd |= 0x08;
                    select.push(SwitchNumber[0]);
                } else {
                    // switch map(row x column 사각형)에서 switch 개수를 초과하는 switch는 '1'로 간주하고 group select를 사용한다.

                    var cCol = SetBitCount(column);
                    var cRow = SetBitCount(row);
//                    dbgout(`set bits count : column(${cCol}), row(${cRow}), select(${nSelect})\n`);
//dbgout(`Variable : ${totalSwitch}, ${deviceType}, ${nRow}, ${nColumn}\n`);
                    var maxRow = nRow;
                    var maxCol = Math.ceil(totalSwitch/nRow);

                    dbgout(`nRow(${nRow}), nColumn(${nColumn}), cRow(${cRow}), cCol(${cCol}), nSelect(${nSelect}), maxRow(${maxRow}), maxCol(${maxCol})\n`);
                    if( (cCol * cRow) == nSelect ) {        // row x column 이 사각형으로 동일한 column/row를 갖는다.
                        if( cCol == nColumn ) {              // all column select -> Row All Switch Command.
                            cmd |= 0x10;
                            if( nRow > 8 ) {
                                select.push((row >> (nRow - 8)) & 0xFF);
                                select.push((row << (16 - nRow)) & 0xFF);
                            } else {
                                select.push((row << (8 - nRow)) & 0xFF);
                            }
                        } else if( cRow == nRow ) {       // all row select -> Column All Switch Command.
                            cmd |= 0x20;
                            if( nColumn > 8 ) {
                                select.push((column >> (nColumn - 8)) & 0xFF);
                                select.push((column << (16 - nColumn)) & 0xFF);
                            } else {
                                select.push((column << (8 - nColumn)) & 0xFF);
                            }
                        } else {                        // partial colum/row select -> Column/Row Select Switch Command.
//                            cmd |= 0x18;                // Row & Switch Select Command.
                            cmd |= 0x28;                // Column & Switch Select Command.

                            if( nColumn > 16 ) {            // PS1120 : 4/6-group(x)
                            } else if( nColumn > 8 ) {     // PS1120 : 8/10/12/-group, PS1060 : 4/6-group
                                select.push((column >> (nColumn - 8)) & 0xFF);
                                select.push((column << (16 - nColumn)) | ((row >> ((nRow+nColumn) - 16)) & 0xFF));   // PS1060 : 6-group
                                if( (nColumn + nRow) > 16 ) {       // PS1120 : 10-group, PS1060 : 4/12/16-group
                                    select.push((row << (24 - (nRow+nColumn))) & 0xFF);
                                }
                            } else {                // PS1120 : 16-group, PS1060 : 8/10/12/16-group, PS1030 : 4/6/8/10/12/16-group
                                if( nColumn == 8 ) {    // PS1120 : 16-group, PS1060 : 8-group, PS1030 : 4-group
                                    select.push((column >> (nColumn - 8)) & 0xFF);
                                    select.push((row << (8 - nRow)) & 0xFF);
                                } else {            // PS1060 : 10/12/16-group, PS1030 : 6/8/10/12/16-group
                                    select.push(((column << (8 - nColumn)) | ((row >> ((nRow + nColumn) - 8))) & 0xFF));
                                    if( (nColumn + nRow) > 16 ) {       // PS1060 : 12/16-group, PS1030 : 16-group.
                                        // 8 - nColumn = 8 - 6 = 2, (nRow + nColumn) - 8 = 18 - 8 = 10
                                        select.push((row >> (nRow + nColumn) - 16) & 0xFF);    // (nRow + nColumn) - 16 = 18 - 16 = 2
                                        select.push((row << (24 - (nRow + nColumn))) & 0xFF);   // 24 - (nRow + nColumn) = 24 - 18 = 6
                                    } else {                            // PS1060 : 10-group, PS1030 : 6/8/10/12-group.
                                        // 16 - (nRow + nColumn) = 16 - 16 = 0;
                                        select.push((row << (16 - (nRow + nColumn))) & 0xFF);
                                    }
                                }
                            }
                        }
//                        dbgout(`select : ${select}\n`);
                    } else {                    // 예외 처리
                        var rArray = new Array(10).fill(0);
                        $('input:checkbox[name="switch[]"]').each(function() {
                            if( this.checked == true ) {
                                var idx = this.value;
//                                rArray[9 - (idx % 10)] |= (1 << (11 - parseInt(idx / 10)));
                                rArray[(nRow-1) - (idx % nRow)] |= (1 << ((nColumn-1) - parseInt(idx / nRow)));
                            }
                        });
//                        dbgout(toShortHexString(rArray));
                        cArray = [];
                        for(var i=0; i<rArray.length; i++) {
                            if( rArray[i] != 0 ) {
                                sel = (1<<i);
                                for(var j=i+1; j<rArray.length; j++) {
                                    if( rArray[i] == rArray[j] ) {
                                        rArray[j] = 0;
                                        sel |= (1<<j);
                                    }
                                }
                                cArray.push(sel);
                            }
                        }
//                        dbgout(`${cArray.length} case : ${toShortHexString(cArray)}\n`);
//                        dbgout(toShortHexString(rArray)+'\n');
//                        dbgout(`rArray = ${toShortHexString(rArray)}, cArray = 0x${toShortHexString(cArray)}\n`);

                        if( nSelect < 3 ) {
                            cmd |= 0x08;
                            for(var i=0; i<nSelect; i++) {
                                if( i != (nSelect - 1) ) {
                                    var tmp = [];
                                    tmp.push(SwitchNumber[i]);
                                    send_command(cs, cmd, tmp); // Single Switch Command.
                                } else {
                                    select.push(SwitchNumber[i]);
                                }
                            }
                        } else if( cArray.length < 3 ) {
                            cmd |= 0x28;                // Column & Switch Select Command.
                            var n = 0;
                            rArray.forEach(function(rSel, idx) {
                                if( rSel != 0 ) {
                                    select = [];
//                                    dbgout(`rSel = ${rSel}, cSel = ${cArray[n]}\n`);
                                    // PS1060 10-group : nRow(10), nColumn(6)
                                    if( nColumn > 16 ) {            // PS1120 : 4/6-group(x)
                                    } else if( nColumn > 8 ) {     // PS1120 : 8/10/12/-group, PS1060 : 4/6-group
                                        select.push((rSel >> (nColumn - 8)) & 0xFF);
                                        select.push(((rSel << (16 - nColumn)) | ((cArray[n] >> ((nRow+nColumn) - 16))) & 0xFF));   // PS1060 : 6-group
                                        if( (nColumn + nRow) > 16 ) {       // PS1120 : 10-group, PS1060 : 4/12/16-group
                                            select.push((cArray[n] << (24 - (nRow+nColumn))) & 0xFF);
                                        }
                                    } else {                // PS1120 : 16-group, PS1060 : 8/10/12/16-group, PS1030 : 4/6/8/10/12/16-group
                                        if( nColumn == 8 ) {    // PS1120 : 16-group, PS1060 : 8-group, PS1030 : 4-group
                                            select.push((rSel >> (nColumn - 8)) & 0xFF);
                                            select.push((cArray[n] << (8 - nRow)) & 0xFF);
                                        } else {            // PS1060 : 10/12/16-group, PS1030 : 6/8/10/12/16-group
                                            select.push((rSel << (8 - nColumn)) | ((cArray[n] >> ((nRow + nColumn) - 8)) & 0xFF));
                                            if( (nColumn + nRow) > 16 ) {       // PS1060 : 12/16-group, PS1030 : 16-group.
                                                // 8 - nColumn = 8 - 6 = 2, (nRow + nColumn) - 8 = 18 - 8 = 10
                                                select.push((cArray[n] >> (nRow + nColumn) - 16) & 0xFF);    // (nRow + nColumn) - 16 = 18 - 16 = 2
                                                select.push((cArray[n] << (24 - (nRow + nColumn))) & 0xFF);   // 24 - (nRow + nColumn) = 24 - 18 = 6
                                            } else {                            // PS1060 : 10-group, PS1030 : 6/8/10/12-group.
                                                // 16 - (nRow + nColumn) = 16 - 16 = 0;
                                                select.push((cArray[n] << (16 - (nRow + nColumn))) & 0xFF);
                                            }
                                        }
                                    }

                                    if( n != (cArray.length - 1) ) {
                                        send_command(cs, cmd, select);
                                        n++;
                                    }
                                }
                            });
                        } else {
                            cmd |= 0x38;                // Select Switch Command.
                            for(var i=0; i<Math.ceil(totalSwitch / 8); i++) select.push(0x0);
                            SwitchNumber.forEach(function(sw, index) {
                                select[sw >> 3] |= (1 << (7 - (sw % 8)));
                            });
                        }
                    }
                }
                send_command(cs, cmd, select);
            }

            $('#deviceSelect').on("change", function() {
//                dbgout(`device select = ${$(this).val()}, ${$(this).find('option:selected').attr('name')}\n`);
                var name = $(this).find('option:selected').attr('name');

                if( $(this).val() == 2 ) {          // PS1120
                    dbgout('change 10-group\n');
                    // 10-Group fix.
                    $('#groupSelect').val('10');                // 10-Group을 select로 선택한다.
                    $('#groupSelect option').prop('disabled', true);            // groupSelect select의 모든 option을 disabled로 설정한다.
                    $('#groupSelect option[value*="10"]').prop('disabled', false);  // groupSelect select에서 value가 '10'인 option만 enable시킨다.
                } else {
                    $('#groupSelect option').prop('disabled', false);       // groupSelect select의 모든 option을 enable시킨다.
                }

                $('.DeviceClass').each(function(index) {
                    $(this).text(name+'['+index+']');
                });

                $('#container').empty();
                create_group_map();
            });

            $('#groupSelect').on("change", function() {
                dbgout(`select value = ${$(this).val()}\n`);
                $('#container').empty();
                create_group_map();
            });

            $(window).on('beforeunload', function() {               // Page Reload event
                if( (SubWindow != undefined) || (SubWindow != NaN) )
                    SubWindow.close();
//                dbgout('It is going to be refreshed');
            });

            $(document).on('change', '#id-cmd', function(e) {
                // device select box에서 option선택시에 background-color를 바꾸어 준다.
                $('#id-cmd').css("background-color", color[e.target.value]);
            });

            $(document).on('click', '#frame', function(e) {
                dbgout(`frame click event : ${e.type}, ${e.target.value}, ${this.checked}\n`);
                var options = $('#frame option');
                var values = $.map(options, function(option) {
                    return option.value;
                });
                dbgout(`history : ${JSON.stringify(values)}\n`);
            });

            $(document).on('click', '#CommandGen', function(e) {
//                dbgout(`button click event : ${e.type}, ${e.target.value}, ${this.checked}\n`);
                var SwitchNumber = [];//new Uint8Array();
                var column = 0;             // column select bits
                var row = 0;                // row select bits
                var cs = 0;

                // check chip select.
                $('input:checkbox[name="Device[]"]').each(function() {
                    if( this.checked ) cs |= (1 << (7 - this.value));
                });
//                dbgout(`cs = ${cs}\n`);

                // read opcode.
                var opcode = $('#id-cmd').val();
//                dbgout(`opcode = ${opcode}\n`);

                // check switch select.
                $('input:checkbox[name="switch[]"]').each(function() {
                    if( this.checked == true ) {
                        var idx = this.value;
                        SwitchNumber.push(Number(this.value));
                        row |= (1 << (nRow - ((idx % nRow)+1)));
                        column |= (1 << (nColumn - (parseInt(idx / nRow) + 1)));
//                        dbgout(`Variable : ${totalSwitch}, ${deviceType}, ${nRow}, ${nColumn}\n`);
//                        dbgout(`${idx} switch : ${nRow - ((idx % nRow) + 1)}, ${nColumn - (parseInt(idx / nRow) + 1)}\n`);
                    }
                });
//                dbgout(`Switch Select(${SwitchNumber.length}) : ${SwitchNumber}\n`);

                if( SwitchNumber.length == 0 ) return;
//                if( (column == 0) || (row == 0) ) return;

                generate_command(cs, opcode, SwitchNumber, column, row);
//dbgout(`device = ${deviceName}, group = ${groupNumber}, cs = ${cs}, opcode = ${opcode}, select = ${SwitchNumber}\n`);
                cmdList.push(cmdFrame);
//                dbgout(`cmdList = ${JSON.stringify(cmdList)}\n`);
//                dbgout(`cmdList length = ${cmdList.length}\n`);

                command_result(opcode, SwitchNumber);
            });



            $(document).on('click', '#Analysis', function(e) {
                var str = '';
                var arr = $('#frame option:selected').val().split(' ').map(Number);

                // Copy to clipboard value of selected option.
                var value=`<input value="${$('#frame option:selected').val()}" id="selVal"/>`;  // input Tag 생성.
                $(value).insertAfter('#frame');     // Tag 추가.
                $('#selVal').select();              // input tag value 선택.
                document.execCommand('Copy');
                $('body').find('#selVal').remove(); // input Tag 제거.
//                dbgout(arr);

                if( arr[0] != 0xAA ) {
                    str += 'Command Sync Pattern Error!\n';
                } else {
                    var idx = 1;
                    var cmd = arr[idx++];           // idx == 2
                    var type = (cmd >> 3) & 0x7;
                    var opcode = cmd & 0x7;
                    var rSel;
                    var cSel;

                    str += (`\n------------ ${arr.length}-Bytes : ${toByteHexString(arr)} -------------\n`);
                    str += (`▶ Command Type : ${CommandType[type]} Command\n`);
                    str += (`▶ Operate Type : ${OperateType[opcode]}\n`);

                    if( cmd & 0x40 ) {
                        var cs = arr[idx++];        // idx == 3
                        str += (`▶ with Chip Select(0x${cs.toString(16)}) : `);
                        for(var i=0; i<8; i++) {
                            if( cs & (1 << (7 - i)) ) {
                                str += (`CHIP[${i}] `);
                            }
                        }
                        str += (`\n`);
                    }

                    if( type == 0 ) {                           // Single Command.
                    } else if( type == 1 ) {                    // Single Switch Command.
                        str += (`▶ Switch Number : ${arr[idx++]}\n`);
                    } else if( (type == 2) || (type == 3) ) {   // Row Select 또는 Row & Switch Select Command.
                        var select;

                        select = arr[idx++] << 8;
                        select |= arr[idx++] << 0;

                        rSel = select >> (16-nRow);
                        str += (`▶ Row Select(0x${rSel.toString(16)}) : `);
                        for(var i=0; i<nRow; i++) {
                            if( rSel & (1 << i) ) {
                                str += (`${i} `);
                            }
                        }
                        str += (`\n`);

                        if( type == 3 ) {
                            if( (nRow + nColumn) > 16 ) {
                                select = (select << 8) | (arr[idx++] << 0);
                                bits = 24 - (nColumn + nRow);
                            } else {
                                bits = 16 - (nColumn + nRow);
                            }
                            cSel = (select >> bits) & maskbits[nColumn];

                            str += (`▶ Column Select(0x${cSel.toString(16)}) : `);
                            for(var i=0; i<nColumn; i++) {
                                if( cSel & (1 << i) ) {
                                    str += (`${i} `);
                                }
                            }
                            str += (`\n`);
                        } else {
                            cSel = 0xFFFF;
                        }
                    } else if( (type == 4) || (type == 5) ) {       // Column Select 또는 Column & Switch Select
                        var select;

                        select = (arr[idx++] << 8);
                        select |= (arr[idx++] << 0);
                        dbgout(`idx = ${idx}`);

//                        cSel = select >> (16 - Math.ceil(totalSwitch / nRow));
                        cSel = select >> (16 - nColumn);
                        str += (`▶ Column Select(0x${cSel.toString(16)}) : `);
                        for(var i=0; i<nColumn; i++) {
                            if( cSel & (1 << i) ) {
                                str += (`${i} `);
                            }
                        }
                        str += (`\n`);

                        if( type == 5 ) {
                            if( (nRow + nColumn) > 16 ) {
                                select = (select << 8) | (arr[idx++] << 0);
                                bits = 24 - (nColumn + nRow);
                            } else {
                                bits = 16 - (nColumn + nRow);
                            }
                            rSel = (select >> bits) & maskbits[nRow];

                            str += (`▶ Row Select(0x${rSel.toString(16)}) : `);
                            for(var i=0; i<nRow; i++) {
                                if( rSel & (1 << i) ) {
                                    str += (`${i} `);
                                }
                            }
                            str += (`\n`);
                        } else {
                            rSel = 0xFFFF;
                        }
                    } else if( type == 6 ) {
                    } else if( type == 7 ) {
                        var nByte = Math.ceil(totalSwitch/8);

                        str += (`▶ Switch Select : `);
                        for(var i=0; i<nByte; i++) {
                            for(var j=0; j<8; j++) {
                                if( ((i*8)+j) < totalSwitch ) {
                                    if( arr[idx] & (1 << (7 - j)) ) {
                                        str += (`${(i*8)+j} `);
                                    }
                                }
                            }
                            idx++;
                        }
                        str += (`\n`);
                    }

                    if( (type == 2) || (type == 3) || (type == 4) || (type == 5) ) {
                        var sw;
                        var n = 0;
                        var fullSwitch = nColumn * nRow;            // totalSwitch를 초과하는 switch number.
//                        dbgout(`cSel = ${cSel.toString(16)}, rSel = ${rSel.toString(16)}\n`);
                        str += (`☞ Switch : `);
                        for(var c=0; c<nColumn; c++) {
                            if( cSel & (1 << c) ) {
                                for(var r=0; r<nRow; r++) {
                                    if( rSel & (1 << r) ) {
                                        sw = (fullSwitch - 1) - ((c * nRow) + r);
                                        if( sw < totalSwitch ) {
                                            str += `${sw} `
                                            if( (++n & 0xF) == 0 ) str += '\n            ';
                                        }
                                    }
                                }
                            }
                        }
                        str += (`\n`);
                    }
                    str += (`▶ Shift Clock : ${(arr.length - idx)*8}, ${arr.length}-${idx}\n`);
                    str += (`------------------------------------------------------------------------`);
                }

                // width와 height는 popup window의 크기를 결정한다.
                // left와 top은 popup window의 왼쪽 상단의 시작점을 결정한다.
                /*
                var left = (screen.width / 2) - (600/2);
                var top = (screen.height / 2) - (200/2);
                left = 1024;
                dbgout(`window : ${window.screenX} x ${window.screenY}\n`);
                dbgout(`screen : ${screen.width} x ${screen.height}, left = ${left}, top = ${top}\n`);
                var opt = `toolbar=no, menubar=no, location=no, status=no, width=600, height=200, left=${left}, top=${top}`;
                */
                var opt = 'toolbar=no, menubar=no, location=no, status=no, width=680, height=200, left=600, top=500';
                SubWindow = window.open('', ' Analysis', opt, true);
//                SubWindow.document.write('<html><head><title>Command Analysis Result</title></head><body onload="window.resizeTo(600,200)">');
                SubWindow.document.write('<html><head><title>Command Analysis Result</title></head><body>');
                if( SubWindow.document.getElementById('console') == null ) {        // 기존에 <textarea>가 있으면, 새로 생성하지 않는다.
                    SubWindow.document.write('<textarea id="console" cols="80" rows="10" style="display:block; resize:none; font-weight:bold"></textarea>');
                }
                SubWindow.document.getElementById('console').value = str;
                SubWindow.document.write('</body></html>');
//                dbgout(str);
//                alert(str);
            });

            function filesave(filename, text) {
                var elem = document.createElement('a');
                elem.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                elem.setAttribute('download', filename);
                elem.style.display = 'none';
                document.body.appendChild(elem);
                elem.click();
                document.body.removeChild(elem);
            }
            $(document).on('click', '#saveAs', function(e) {
//                dbgout(`cmdList : ${JSON.stringify(cmdList)}\n`);
                filesave("command list.json", JSON.stringify(cmdList));
            });

            $(document).on('change', '#frame', function(e) {
                $('#frame').select();
            });

            $(document).on('click', '#all_switch_toggle', function(e) {
//                dbgout(`all switch toggle click event : ${e.type}, ${e.target.value}, ${this.checked}\n`);
                $('input:checkbox[name="switch[]"]').prop('checked', this.checked);          // 전체 switch 선택/해제.
            });

            $(document).on('click', '*[name="row_select"]', function(e) {
//                dbgout(`row select click event : ${e.type}, ${e.target.value}, ${this.checked}\n`);
                var checked = this.checked;
                var row = nRow - (parseInt(e.target.value) + 1);
//                dbgout(`row = ${e.target.value}, ${row}\n`);
                $('input:checkbox[name="switch[]"]').each(function() {
                    if( (this.value % nRow) == row ) {
                        this.checked = checked;
                    }
                });
            });

            $(document).on('click', '*[name="column_select"]', function(e) {
//                dbgout(`column select click event : ${e.type}, ${e.target.value}, ${this.checked}\n`);
                var checked = this.checked;
                var column = (nColumn - (parseInt(e.target.value) + 1));
//                dbgout(`column = ${e.target.value}, ${column}\n`);
                $('input:checkbox[name="switch[]"]').each(function(index) {
                    if( parseInt(this.value / nRow) == column ) {
                        this.checked = checked;
                    }
                });
            });

            $(document).on('click', '#console', function(e) {
                $('#console').scrollTop( $('#console')[0].scrollHeight );     // 속도가 너무 느리다.
            });

            function dbgout(s) {
                $('#console').val( $('#console').val() + s);
//                $('#console').scrollTop( $('#console')[0].scrollHeight );     // 속도가 너무 느리다.
            }

        </script>
    </body>
</html>



